<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KurdishGPT Localized Chat Interface</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>

    <style>
        /* --- CSS Variables and Dark Mode Styling --- */
        :root {
            --bg-dark: #000000;
            --input-dark: #1f1f1f;
            --purple-prime: #6d28d9;
            --user-bubble: #348feb;
            --ai-bubble: #2e2e2e;
            --text-light: #ffffff;
            --text-faded: #a0a0a0;
            --input-border: #444444;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            overflow-x: hidden;
            /* FIXED LAYOUT: Layout direction is permanently LTR */
            direction: ltr; 
        }

        /* Input bar fixed positioning */
        #input-container { z-index: 10; }

        /* Hide scrollbars for the chat container */
        #chat-container-scrollable::-webkit-scrollbar { width: 0; background: transparent; }
        #chat-container-scrollable { scrollbar-width: none; }

        /* Custom style for the new prompt buttons */
        .prompt-button {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            border: 1px solid var(--input-border);
            border-radius: 9999px; /* Pill shape */
            background-color: transparent;
            color: var(--text-light);
            font-size: 0.875rem;
            transition: background-color 0.15s;
            justify-content: center;
            flex-grow: 1; /* Allow stretching in flex layout */
        }
        .prompt-button:hover { background-color: rgba(255, 255, 255, 0.1); }
        .prompt-button i { margin-right: 8px; }

        /* Markdown Styling - Important for the streaming content */
        .markdown-content { white-space: pre-wrap; }
        .markdown-content h1 { font-size: 1.5em; font-weight: 700; margin-top: 1em; }
        .markdown-content h2 { font-size: 1.3em; font-weight: 600; margin-top: 1em; }
        .markdown-content p { margin-bottom: 0.5em; }
        .markdown-content ul, .markdown-content ol { list-style-position: inside; margin-left: 1.5em; margin-bottom: 0.5em; }
        .markdown-content code { background-color: #383838; padding: 2px 4px; border-radius: 4px; }
        .markdown-content pre { background-color: #1a1a1a; padding: 10px; border-radius: 6px; overflow-x: auto; margin-top: 1em; margin-bottom: 1em; border: 1px solid #1f1f1f; }
        .ai-bubble-footer { border-top: 1px solid #1a1a1a; }
        .ai-bubble-footer button { color: var(--text-faded); }

        /* --- Typing Cursor Animation --- */
        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background-color: var(--text-light);
            margin-left: 1px;
            vertical-align: middle;
            animation: blink 0.8s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* Custom spinner for loading image */
        .image-loading {
            width: 24px;
            height: 24px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid var(--purple-prime);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex flex-col h-screen antialiased">

    <!-- SIDEBAR BACKDROP & MENU -->
    <div id="sidebar-backdrop" onclick="toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-75 z-40 transition-opacity duration-300 opacity-0 pointer-events-none"></div>

    <aside id="sidebar-menu" class="fixed top-0 left-0 h-full w-64 bg-black z-50 transform -translate-x-full transition-transform duration-300 shadow-2xl flex flex-col justify-between p-4 border-r border-gray-900">

        <!-- TOP SECTION: Search & Main Links -->
        <div>

            <div class="flex items-center justify-between p-2 mb-4">
                <div class="flex items-center text-gray-400 w-full">
                    <i data-lucide="search" class="w-5 h-5 mr-2 flex-shrink-0"></i>
                    <input type="text" data-l10n-key="search" placeholder="Search" class="bg-black text-white placeholder-gray-500 w-full focus:outline-none" />
                </div>
                <button onclick="toggleSidebar()" class="text-gray-400 hover:text-white p-1 rounded-full flex-shrink-0" aria-label="Close sidebar">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="space-y-1">
                <a href="#" onclick="clearChat(true); toggleSidebar();" class="flex items-center p-3 rounded-xl hover:bg-[#1a1a1a] transition-colors text-white font-medium">
                    <i data-lucide="sparkles" class="w-5 h-5 mr-3 text-purple-400"></i>
                    <span data-l10n-key="new_chat">New chat</span>
                </a>

                <a href="#" onclick="showFeatureNotAvailable('Library'); toggleSidebar();" class="flex items-center p-3 rounded-xl hover:bg-[#1a1a1a] transition-colors text-white">
                    <i data-lucide="bookmark" class="w-5 h-5 mr-3 text-yellow-400"></i>
                    <span data-l10n-key="library">Library</span>
                </a>

                <a href="#" onclick="showFeatureNotAvailable('GPTs'); toggleSidebar();" class="flex items-center p-3 rounded-xl hover:bg-[#1a1a1a] transition-colors text-white">
                    <i data-lucide="bot" class="w-5 h-5 mr-3 text-red-400"></i>
                    <span data-l10n-key="gpts">GPTs</span>
                </a>

            </div>

            <!-- RECENT CHATS -->
            <div class="mt-6">
                <h3 class="text-xs font-semibold uppercase text-gray-500 mb-2 px-3" data-l10n-key="recent_chats_title">Recent Chats</h3>
                <div id="recent-chats-list" class="space-y-1">
                    <!-- Recent chats will be inserted here -->
                    <p class="text-xs text-gray-600 px-3 py-1" data-l10n-key="no_recent_chats">No recent chats</p>
                </div>
            </div>

        </div>


        <!-- BOTTOM SECTION: User Profile/Settings -->
        <div class="border-t border-gray-800 pt-4">

            <a href="#" onclick="showFeatureNotAvailable('User Profile')" class="flex items-center p-3 rounded-xl hover:bg-[#1a1a1a] transition-colors">
                <i data-lucide="user" class="w-6 h-6 mr-3 text-gray-300"></i>
                <span class="font-semibold">KURDISHGPT</span>
                <i data-lucide="chevron-down" class="w-4 h-4 ml-auto text-gray-400"></i>
            </a>
        </div>
    </aside>


    <!-- HEADER -->
    <header class="flex justify-between items-center p-4 h-16 sticky top-0 bg-black z-20 border-b border-gray-900">

        <!-- Left: Sidebar Toggle / Back Button (on desktop) -->
        <button onclick="toggleSidebar()" class="text-white p-2 rounded-full hover:bg-gray-900 transition-colors" aria-label="Open menu">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>

        <!-- Center: Language/Translation Button (NEW) -->
        <div class="flex-grow flex justify-center">
            <button id="language-toggle-button" onclick="toggleLanguage()" 
                    class="flex items-center px-3 py-2 rounded-full font-semibold transition-colors text-white text-sm shadow-lg" 
                    style="background-color: var(--purple-prime);">
                <i data-lucide="globe" class="w-4 h-4 mr-2"></i>
                <span id="current-language-display">English</span>
            </button>
        </div>

        <!-- Right: New Chat Button -->
        <button onclick="clearChat(true)" class="text-white p-2 rounded-full hover:bg-gray-900 transition-colors" aria-label="Start new chat">
            <i data-lucide="rotate-cw" class="w-6 h-6"></i>
        </button>
    </header>


    <!-- MAIN CHAT/HOME CONTENT -->
    <main id="main-content" class="flex-grow flex flex-col items-center justify-start p-4 overflow-y-auto" role="log">

        <div id="home-screen" class="w-full max-w-xl text-center flex flex-col items-center p-4">
            <h1 class="text-3xl font-semibold mb-10 mt-16 text-center" data-l10n-key="home_title">What can I help with?</h1>

            <!-- Prompt Suggestions with ChatGPT-like style -->
            <div id="suggestion-buttons" class="grid grid-cols-2 gap-3 w-full px-4 sm:px-0">

                <button onclick="setPrompt(CONFIG.PROMPTS.image.trim())" class="prompt-button">
                    <i data-lucide="image" class="w-5 h-5 text-green-400"></i>
                    <span data-l10n-key="prompt_image">Create image</span>
                </button>
                <button onclick="setPrompt(CONFIG.PROMPTS.summarize.trim())" class="prompt-button">
                    <i data-lucide="file-text" class="w-5 h-5 text-orange-400"></i>
                    <span data-l10n-key="prompt_summarize">Summarize text</span>
                </button>
                <button onclick="setPrompt(CONFIG.PROMPTS.brainstorm.trim())" class="prompt-button">
                    <i data-lucide="lightbulb" class="w-5 h-5 text-yellow-400"></i>
                    <span data-l10n-key="prompt_brainstorm">Brainstorm</span>
                </button>
                <button onclick="setPrompt(CONFIG.PROMPTS.more.trim())" class="prompt-button">
                    <i data-lucide="more-horizontal" class="w-5 h-5 text-purple-400"></i>
                    <span data-l10n-key="prompt_more">More</span>
                </button>
            </div>
        </div>


        <div id="chat-container-scrollable" class="hidden w-full h-full max-w-2xl mx-auto overflow-y-auto pt-4 pb-20">

        </div>

    </main>

    <!-- ADD TOOLS MODAL OVERLAY -->
    <div id="add-tools-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-90 flex flex-col pt-16">
        <div class="absolute top-0 left-0 w-full p-4 flex justify-start">
            <button onclick="closeAddToolsModal()" class="text-white p-2" aria-label="Close tools menu">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Top Grid of Primary Actions (Camera, Photos, Files) -->
        <div class="w-full px-8 mb-8 mt-4">
            <div class="grid grid-cols-3 gap-4 max-w-sm mx-auto">
                <!-- Camera -->
                <button onclick="handleToolAction('Camera')" class="flex flex-col items-center p-4 rounded-xl text-sm font-medium transition-colors hover:bg-gray-800" style="background-color: #1f1f1f;">
                    <i data-lucide="camera" class="w-8 h-8 mb-2 text-white"></i>
                    <p data-l10n-key="tool_camera">Camera</p>
                </button>
                <!-- Photos -->
                <button onclick="handleToolAction('Photos')" class="flex flex-col items-center p-4 rounded-xl text-sm font-medium transition-colors hover:bg-gray-800" style="background-color: #1f1f1f;">
                    <i data-lucide="image" class="w-8 h-8 mb-2 text-white"></i>
                    <p data-l10n-key="tool_photos">Photos</p>
                </button>
                <!-- Files -->
                <button onclick="handleToolAction('Files')" class="flex flex-col items-center p-4 rounded-xl text-sm font-medium transition-colors hover:bg-gray-800" style="background-color: #1f1f1f;">
                    <i data-lucide="folder" class="w-8 h-8 mb-2 text-white"></i>
                    <p data-l10n-key="tool_files">Files</p>
                </button>
            </div>
        </div>

        <!-- Tools List -->
        <div class="flex-grow overflow-y-auto px-6 space-y-2">
            <!-- Create Image -->
            <button onclick="handleToolAction('Create image', CONFIG.PROMPTS.image)" class="w-full flex items-center p-4 rounded-xl text-left hover:bg-gray-900 transition-colors">
                <i data-lucide="image" class="w-6 h-6 mr-4 text-green-400"></i>
                <div>
                    <p class="font-semibold text-white" data-l10n-key="tool_image_title">Create image</p>
                    <p class="text-xs text-gray-400" data-l10n-key="tool_image_desc">Visualize anything</p>
                </div>
            </button>

            <!-- Thinking -->
            <button onclick="handleToolAction('Thinking', CONFIG.PROMPTS.thinking)" class="w-full flex items-center p-4 rounded-xl text-left hover:bg-gray-900 transition-colors">
                <i data-lucide="lightbulb" class="w-6 h-6 mr-4 text-yellow-400"></i>
                <div>
                    <p class="font-semibold text-white" data-l10n-key="tool_thinking_title">Thinking</p>
                    <p class="text-xs text-gray-400" data-l10n-key="tool_thinking_desc">Think longer for better answers</p>
                </div>
            </button>

            <!-- Deep research -->
            <button onclick="handleToolAction('Deep research', CONFIG.PROMPTS.research)" class="w-full flex items-center p-4 rounded-xl text-left hover:bg-gray-900 transition-colors">
                <i data-lucide="flask-round" class="w-6 h-6 mr-4 text-red-400"></i>
                <div>
                    <p class="font-semibold text-white" data-l10n-key="tool_research_title">Deep research</p>
                    <p class="text-xs text-gray-400" data-l10n-key="tool_research_desc">Get a detailed report</p>
                </div>
            </button>

            <!-- Web search -->
            <button onclick="handleToolAction('Web search', CONFIG.PROMPTS.search)" class="w-full flex items-center p-4 rounded-xl text-left hover:bg-gray-900 transition-colors">
                <i data-lucide="globe" class="w-6 h-6 mr-4 text-blue-400"></i>
                <div>
                    <p class="font-semibold text-white" data-l10n-key="tool_web_title">Web search</p>
                    <p class="text-xs text-gray-400" data-l10n-key="tool_web_desc">Find real-time news and info</p>
                </div>
            </button>

            <!-- Study and learn -->
            <button onclick="handleToolAction('Study and learn', CONFIG.PROMPTS.study)" class="w-full flex items-center p-4 rounded-xl text-left hover:bg-gray-900 transition-colors">
                <i data-lucide="book-open-text" class="w-6 h-6 mr-4 text-purple-400"></i>
                <div>
                    <p class="font-semibold text-white" data-l10n-key="tool_study_title">Study and learn</p>
                    <p class="text-xs text-gray-400" data-l10n-key="tool_study_desc">Learn a new concept</p>
                </div>
            </button>
        </div>

        <!-- Explore Tools Button -->
        <div class="p-6">
            <button onclick="handleToolAction('Explore tools')" class="w-full py-3 rounded-full font-bold text-center transition-colors" style="background-color: var(--ai-bubble); color: var(--text-light);" data-l10n-key="explore_tools">
                Explore tools
            </button>
        </div>
    </div>


    <!-- INPUT BAR / FOOTER (ChatGPT Style) -->
    <footer id="input-container" class="fixed bottom-0 w-full max-w-2xl mx-auto p-4 flex flex-col items-center">
        <div class="w-full flex items-end p-2 rounded-2xl border" style="background-color: var(--input-dark); border-color: var(--input-border);">

            <!-- Left: Attachment/Tools Button (Always visible) -->
            <button id="attachment-button" onclick="openAddToolsModal()"
                    class="flex-shrink-0 p-2 text-gray-500 hover:text-white transition-colors"
                    aria-label="Add attachment or open tools" data-l10n-key="input_attachment_aria" title="Add attachment or open tools">
                <i data-lucide="plus" class="w-6 h-6"></i>
            </button>

            <!-- Center: Input Wrapper -->
            <div class="flex flex-grow items-center mx-1">
                <input id="chat-input"
                       type="text"
                       data-l10n-key="input_placeholder"
                       placeholder="Ask KurdishGPT"
                       oninput="checkInputStatus()"
                       class="w-full bg-transparent text-white focus:outline-none py-2 text-base">
            </div>

            <!-- Right: Send or Mic/Wave Button -->

            <!-- Send Button (Hidden by default) -->
            <button id="send-button" onclick="handleSendMessage()"
                    class="flex-shrink-0 p-2 text-blue-400 hover:text-blue-300 transition-colors hidden"
                    aria-label="Send message" data-l10n-key="input_send_aria" title="Send message">
                <i data-lucide="send" class="w-6 h-6"></i>
            </button>

            <!-- Mic/Wave Button (Visible when input is empty) -->
            <button id="mic-button" onclick="showFeatureNotAvailable('Voice Input')"
                    class="flex-shrink-0 p-2 text-gray-500 hover:text-white transition-colors"
                    aria-label="Voice input" data-l10n-key="input_voice_aria" title="Voice input">
                <!-- Using a volume icon to represent the voice prompt indicator -->
                <i data-lucide="volume-2" class="w-6 h-6"></i>
            </button>

        </div>
    </footer>


<script>
    // --- GLOBAL STATE ---
    let chatHistory = [];
    let isTyping = false;
    let currentLanguage = 'en'; // Initial state: 'en' (English)
    
    
    // --- Configuration (Simulating import config from "./config") ---
    // This object simulates the content of an external config.js file.
    const config = {
        // The API Key MUST be an empty string for the runtime to inject it securely.
        apiKey: "", 
        modelName: "gemini-2.0-flash", 
        imageModelName: "imagen-3.0-generate-002",
        // The full path will be constructed in the function using v1
        apiBaseUrlText: "https://generativelanguage.googleapis.com/v1", 
        // Image generation still uses v1beta endpoint structure for Imagen.
        apiBaseUrlImage: "https://generativelanguage.googleapis.com/v1beta/models/", 
        maxTokens: 2048,
        temperature: 0.7, 
        enableSearchGrounding: true,
    };

    // Configuration for static text and prompts
    const CONFIG = {
        PROMPTS: {
            image: 'Generate a high-quality image of ',
            summarize: 'Summarize the plot of ',
            brainstorm: 'Brainstorm 5 ideas for a startup in Erbil.',
            more: 'What are some fun facts about the Kurdistan Region of Iraq?',
            thinking: 'Analyze the historical significance of the Medes.',
            research: 'Write a deep report on the future of Kurdish language technology.',
            search: 'What is the current price of oil?',
            study: 'Explain the concept of neural networks in simple terms.',
        },
        MESSAGES: {
            action_copy_success: 'Content copied to clipboard!',
            action_copied: 'Copied.',
            action_tts: 'Text-to-Speech is playing the response now.',
            action_regenerate: 'Regenerating response...',
            action_like: 'Thanks for the feedback!',
            action_dislike: 'Thanks for the feedback. We will improve.',
            action_feature_not_available: (feature) => `${feature} feature is not yet available in this clone.`,
            error_api_call_failed: 'Failed to get a response from the API. Please check the console for details.',
            error_api_blocked: 'The response was blocked due to safety settings.',
            error_image_failed: 'Failed to generate image. The prompt might be too complex or blocked by safety filters.',
            image_success: 'Here is the image I generated for you:',
        },
        // LOCAL STORAGE KEYS
        STORAGE_KEY: {
            RECENT_CHATS: 'kurdish_gpt_recent_chats',
            MAX_CHATS: 5,
        }
    };

    // Localization Map (L10N) for UI elements (English and Kurdish/Sorani)
    const L10N = {
        'en': {
            // General UI
            'new_chat': 'New chat',
            'library': 'Library',
            'gpts': 'GPTs',
            'search': 'Search',
            'recent_chats_title': 'Recent Chats',
            'no_recent_chats': 'No recent chats',
            'home_title': 'What can I help with?',
            'input_placeholder': 'Ask KurdishGPT',
            'input_attachment_aria': 'Add attachment or open tools',
            'input_send_aria': 'Send message',
            'input_voice_aria': 'Voice input',
            'explore_tools': 'Explore tools',
            
            // Prompt Suggestions
            'prompt_image': 'Create image',
            'prompt_summarize': 'Summarize text',
            'prompt_brainstorm': 'Brainstorm',
            'prompt_more': 'More',

            // Tools Modal
            'tool_camera': 'Camera',
            'tool_photos': 'Photos',
            'tool_files': 'Files',
            'tool_image_title': 'Create image',
            'tool_image_desc': 'Visualize anything',
            'tool_thinking_title': 'Thinking',
            'tool_thinking_desc': 'Think longer for better answers',
            'tool_research_title': 'Deep research',
            'tool_research_desc': 'Get a detailed report',
            'tool_web_title': 'Web search',
            'tool_web_desc': 'Find real-time news and info',
            'tool_study_title': 'Study and learn',
            'tool_study_desc': 'Learn a new concept',

            // Toast Messages (Updated for clarity)
            'lang_set_to': 'Output language set to English. All subsequent AI responses will be in English.',
            'lang_switch_title': (current) => `Current output language: ${current}. Click to switch to Kurdish (کوردی).`,
            
            // Internal use
            'lang_display': 'English',
            'lang_api_instruction': "Respond naturally in English and follow the user's prompt.",
        },
        'ku': {
            // General UI
            'new_chat': 'چاتی نوێ',
            'library': 'کتێبخانە',
            'gpts': 'مۆدێلەکان',
            'search': 'گەڕان',
            'recent_chats_title': 'چاتە نوێکانی دوایی',
            'no_recent_chats': 'هیچ چاتێکی نوێ نییە',
            'home_title': 'چیم پێ دەکرێت بۆت؟',
            'input_placeholder': 'پرسیار لە کوردیش جی پی تی بکە',
            'input_attachment_aria': 'زیادکردنی پاشکۆ یان کردنەوەی ئامرازەکان',
            'input_send_aria': 'ناردنی پەیام',
            'input_voice_aria': 'دەنگی',
            'explore_tools': 'پشکنینی ئامرازەکان',

            // Prompt Suggestions
            'prompt_image': 'وێنە دروست بکە',
            'prompt_summarize': 'پوختەکردنی دەق',
            'prompt_brainstorm': 'بیرکردنەوە',
            'prompt_more': 'زیاتر',

            // Tools Modal
            'tool_camera': 'کامێرا',
            'tool_photos': 'وێنەکان',
            'tool_files': 'فایلەکان',
            'tool_image_title': 'وێنە دروست بکە',
            'tool_image_desc': 'هەر شتێک بهێنە بەرچاو',
            'tool_thinking_title': 'بیرکردنەوە',
            'tool_thinking_desc': 'زیاتر بیر بکەوە بۆ وەڵامی باشتر',
            'tool_research_title': 'لێکۆڵینەوەی قووڵ',
            'tool_research_desc': 'ڕاپۆرتێکی ووردو وەرگرە',
            'tool_web_title': 'گەڕانی وێب',
            'tool_web_desc': 'هەواڵی کاتی و زانیاری بدۆزەوە',
            'tool_study_title': 'خوێندن و فێربوون',
            'tool_study_desc': 'چەمکێکی نوێ فێربە',

            // Toast Messages (Updated for clarity)
            'lang_set_to': 'زمانی دەرچوون گۆڕا بۆ کوردی (کوردی). هەموو پەیامی وەڵامەکانی داهاتووی AI بە کوردی دەبێت.',
            'lang_switch_title': (current) => `زمانی دەرچوونی ئێستا: ${current}. کلیک بکە بۆ گۆڕین بۆ ئینگلیزی.`,
            
            // Internal use
            'lang_display': 'کوردی (کوردی)',
            'lang_api_instruction': "All responses MUST be translated into Kurdish (Sorani dialect: کوردی) and follow the user's prompt. Ensure the response is in Kurdish.",
        }
    };


    // Markdown Converter Setup
    const converter = new showdown.Converter({
        tables: true,
        strikethrough: true,
        tasklists: true,
        simpleLineBreaks: true
    });


    // --- LOCALIZATION & UI FIXES ---

    /** Updates all static UI elements based on the currentLanguage state. */
    function updateUIForLanguage() {
        const lang = currentLanguage;
        const dict = L10N[lang];

        // 1. Update all elements with data-l10n-key
        document.querySelectorAll('[data-l10n-key]').forEach(el => {
            const key = el.getAttribute('data-l10n-key');
            if (dict[key]) {
                if (el.tagName === 'INPUT' && el.type === 'text') {
                    el.placeholder = dict[key];
                } else if (key.endsWith('_aria') || key.endsWith('_title')) {
                    // Update aria-label/title attributes if necessary
                    el.setAttribute('title', dict[key]);
                    el.setAttribute('aria-label', dict[key]);
                } else {
                    el.textContent = dict[key];
                }
            }
        });

        // 2. Update the language toggle button display
        const langDisplay = document.getElementById('current-language-display');
        const langButton = document.getElementById('language-toggle-button');
        
        langDisplay.textContent = dict['lang_display'];
        
        // 3. Update title attribute (NO document.body.style.direction CHANGE)
        const nextLang = currentLanguage === 'en' ? 'ku' : 'en';
        langButton.title = L10N[nextLang].lang_switch_title(dict['lang_display']);
        
        // Note: The UI now maintains the default LTR layout regardless of language.
    }


    /** Toggles the translation language. */
    function toggleLanguage() {
        const newLang = currentLanguage === 'en' ? 'ku' : 'en';
        currentLanguage = newLang;

        // 1. Update all UI text 
        updateUIForLanguage();
        
        // 2. Show confirmation toast
        const toastMessage = L10N[newLang].lang_set_to;
        showToast(toastMessage);
    }
    
    // --- RECENT CHATS IMPLEMENTATION (UPDATED) ---

    /** Loads and renders recent chats from local storage. */
    function loadRecentChats() {
        const chatListDiv = document.getElementById('recent-chats-list');
        const chatsJSON = localStorage.getItem(CONFIG.STORAGE_KEY.RECENT_CHATS);
        let chats = chatsJSON ? JSON.parse(chatsJSON) : [];

        chatListDiv.innerHTML = '';
        
        if (chats.length === 0) {
            const noChats = document.createElement('p');
            noChats.className = 'text-xs text-gray-600 px-3 py-1';
            noChats.setAttribute('data-l10n-key', 'no_recent_chats');
            chatListDiv.appendChild(noChats);
            // Re-run localization to ensure "No recent chats" is correct
            updateUIForLanguage(); 
        } else {
            chats.forEach((chat) => {
                const link = document.createElement('a');
                link.href = '#';
                link.className = 'flex items-center p-3 rounded-xl hover:bg-[#1a1a1a] transition-colors text-white text-sm truncate';
                link.textContent = chat.title;
                link.onclick = (e) => {
                    e.preventDefault();
                    // In a full app, this would load the chat by its ID/history.
                    showFeatureNotAvailable(`Loading Chat: "${chat.title}"`);
                    toggleSidebar();
                };
                chatListDiv.appendChild(link);
            });
        }
    }

    /** Saves the current chat (if new or updated) to local storage. */
    function saveCurrentChat() {
        // Ensure the chat has at least one user message to derive a title
        const firstUserMessage = chatHistory.find(msg => msg.role === 'user');
        if (!firstUserMessage) return;

        let chatTitle = firstUserMessage.content.substring(0, 40);
        if (firstUserMessage.content.length > 40) chatTitle += '...';

        const chatsJSON = localStorage.getItem(CONFIG.STORAGE_KEY.RECENT_CHATS);
        let chats = chatsJSON ? JSON.parse(chatsJSON) : [];

        // Check if a chat with this title already exists (and update its position to the top)
        chats = chats.filter(chat => chat.title !== chatTitle);

        // Add new chat to the top
        const newChatEntry = { id: Date.now(), title: chatTitle };
        chats.unshift(newChatEntry);

        // Limit the list size
        chats = chats.slice(0, CONFIG.STORAGE_KEY.MAX_CHATS);

        localStorage.setItem(CONFIG.STORAGE_KEY.RECENT_CHATS, JSON.stringify(chats));
        loadRecentChats(); // Re-render the sidebar list
    }

    // --- CHAT INTERFACE FUNCTIONS (UPDATED) ---

    /** Toggles the sidebar visibility. */
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar-menu');
        const backdrop = document.getElementById('sidebar-backdrop');
        const isOpen = sidebar.classList.contains('translate-x-0');

        if (isOpen) {
            sidebar.classList.remove('translate-x-0');
            sidebar.classList.add('-translate-x-full');
            backdrop.classList.remove('opacity-100', 'pointer-events-auto');
            backdrop.classList.add('opacity-0', 'pointer-events-none');
        } else {
            sidebar.classList.remove('-translate-x-full');
            sidebar.classList.add('translate-x-0');
            backdrop.classList.remove('opacity-0', 'pointer-events-none');
            backdrop.classList.add('opacity-100', 'pointer-events-auto');
        }
    }

    /** Clears the chat history and resets the view to the home screen. */
    function clearChat(shouldSave) {
        // Automatically save the current chat if it has history and a title.
        if (shouldSave && chatHistory.length > 1) {
            saveCurrentChat();
        }

        chatHistory = [];
        const chatContainer = document.getElementById('chat-container-scrollable');
        const homeScreen = document.getElementById('home-screen');
        chatContainer.innerHTML = '';
        chatContainer.classList.add('hidden');
        homeScreen.classList.remove('hidden');
        document.getElementById('chat-input').value = '';
        checkInputStatus();
    }
    
    /** Main function to handle sending a message (user prompt). */
    function handleSendMessage() {
        const inputElement = document.getElementById('chat-input');
        const userPrompt = inputElement.value.trim();

        if (userPrompt === '' || isTyping) return;

        // 1. Setup view
        document.getElementById('home-screen').classList.add('hidden');
        document.getElementById('chat-container-scrollable').classList.remove('hidden');

        // 2. Add user message
        chatHistory.push({ role: 'user', content: userPrompt });
        renderMessage('user', userPrompt);

        // 3. Clear input and disable
        inputElement.value = '';
        checkInputStatus();
        inputElement.setAttribute('disabled', 'true');
        isTyping = true;

        // 4. Render AI thinking/typing bubble
        const thinkingBubble = renderMessage('model', 'Thinking...', true);
        
        // 5. Determine if this is an image or text request
        const isImageRequest = userPrompt.startsWith(CONFIG.PROMPTS.image.trim());

        // 6. Define the translation instruction based on the current language
        const translationInstruction = L10N[currentLanguage].lang_api_instruction;

        // 7. Call the appropriate API
        if (isImageRequest) {
            generateImage(userPrompt, thinkingBubble, translationInstruction);
        } else {
            callGeminiTextAPI(userPrompt, thinkingBubble, translationInstruction);
        }
    }

    // --- API HANDLERS (UPDATED to use 'config') ---

    /** Calls the Gemini API for TEXT generation. */
    async function callGeminiTextAPI(prompt, thinkingBubble, systemInstruction) {
        // Use the 'config' object instead of GEMINI_CONFIG
        const apiKey = config.apiKey;
        const model = config.modelName; 
        
        // Use the new v1 base URL and construct the full path
        const apiUrl = `${config.apiBaseUrlText}/models/${model}:generateContent?key=${apiKey}`;

        // Build the chat history for context
        const contents = chatHistory.map(msg => ({
            role: msg.role === 'model' ? 'model' : 'user', 
            parts: [{ text: msg.content }]
        })).slice(-10);

        const payload = {
            contents: contents,
            generationConfig: {
                maxOutputTokens: config.maxTokens,
                temperature: config.temperature,
            },
            systemInstruction: {
                parts: [{ text: systemInstruction }]
            },
            ...(config.enableSearchGrounding && { tools: [{ "google_search": {} }] })
        };
        
        const maxRetries = 3;
        let attempt = 0;
        let finalResult = null;
        let success = false;

        while (attempt < maxRetries && !success) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                finalResult = await response.json();
                success = true;

            } catch (error) {
                console.error(`Gemini Text API Attempt ${attempt + 1} failed:`, error);
                attempt++;
                if (attempt < maxRetries) {
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        const candidate = finalResult?.candidates?.[0];
        
        let aiResponseText = CONFIG.MESSAGES.error_api_call_failed;
        let sources = [];

        if (candidate && candidate.content?.parts?.[0]?.text) {
            aiResponseText = candidate.content.parts[0].text;
            
            // Extract grounding sources
            const groundingMetadata = candidate.groundingMetadata;
            if (groundingMetadata && groundingMetadata.groundingAttributions) {
                sources = groundingMetadata.groundingAttributions
                    .map(attribution => ({
                        uri: attribution.web?.uri,
                        title: attribution.web?.title,
                    }))
                    .filter(source => source.uri && source.title);
            }

        } else if (candidate?.safetyRatings?.length > 0) {
            aiResponseText = CONFIG.MESSAGES.error_api_blocked;
            console.warn("Response blocked by safety settings:", candidate.safetyRatings);
        }

        try {
            await streamResponse(aiResponseText, thinkingBubble, sources);
        } catch (e) {
            console.error("Error during response streaming:", e);
            showToast("An error occurred while displaying the response.");
        }
        
        // NEW LOGIC: Save chat if this is the first response
        if (chatHistory.length === 2) {
            saveCurrentChat();
        }

        // Re-enable input
        enableInput();
    }


    /** Calls the Imagen API for IMAGE generation. */
    async function generateImage(userPrompt, thinkingBubble) {
        // Use the 'config' object instead of GEMINI_CONFIG
        const apiKey = config.apiKey; 
        const model = config.imageModelName; 

        // Use the dedicated image API base URL
        const apiUrl = `${config.apiBaseUrlImage}${model}:predict?key=${apiKey}`;
        
        // Extract the actual image prompt part
        const imagePrompt = userPrompt.substring(CONFIG.PROMPTS.image.length).trim();

        const payload = { 
            instances: { prompt: imagePrompt }, 
            parameters: { "sampleCount": 1} 
        };

        const maxRetries = 3;
        let attempt = 0;
        let finalResult = null;
        let success = false;

        // Replace loading dots with spinner
        const contentDiv = thinkingBubble.querySelector('.markdown-content');
        contentDiv.innerHTML = `<div class="flex flex-col items-center justify-center p-4">
                                    <div class="image-loading"></div>
                                    <p class="mt-2 text-sm text-gray-400">Generating Image...</p>
                                </div>`;

        while (attempt < maxRetries && !success) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                finalResult = await response.json();
                success = true;

            } catch (error) {
                console.error(`Imagen API Attempt ${attempt + 1} failed:`, error);
                attempt++;
                if (attempt < maxRetries) {
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        const prediction = finalResult?.predictions?.[0];
        const base64Data = prediction?.bytesBase64Encoded;
        
        // Remove the old content and replace with image or error
        contentDiv.innerHTML = ''; 

        if (base64Data) {
            const imageUrl = `data:image/png;base64,${base64Data}`;
            renderImageResult(imageUrl, thinkingBubble, imagePrompt);
            // Add a mock text response to history for context
            chatHistory.push({ role: 'model', content: `[Generated image for: "${imagePrompt}"]` }); 
        } else {
            contentDiv.innerHTML = `<p class="text-red-400">${CONFIG.MESSAGES.error_image_failed}</p>`;
            // Add failure message to history
            chatHistory.push({ role: 'model', content: `[Image generation failed for: "${imagePrompt}"]` }); 
        }

        // NEW LOGIC: Save chat if this is the first response
        if (chatHistory.length === 2) {
            saveCurrentChat();
        }

        thinkingBubble.querySelector('.ai-bubble-footer').classList.remove('hidden');
        enableInput();
    }
    
    // --- UTILITY & VIEW FUNCTIONS ---

    /** Sets the text input value and focuses it. Used by suggestion buttons. */
    function setPrompt(prompt) {
        document.getElementById('chat-input').value = prompt;
        document.getElementById('chat-input').focus();
        checkInputStatus();
    }

    /** Switches the input bar buttons between Mic/Wave and Send based on input text. */
    function checkInputStatus() {
        const input = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const micButton = document.getElementById('mic-button');

        if (input.value.trim().length > 0) {
            sendButton.classList.remove('hidden');
            micButton.classList.add('hidden');
        } else {
            sendButton.classList.add('hidden');
            micButton.classList.remove('hidden');
        }
    }

    /** Opens the Add Tools modal. */
    function openAddToolsModal() { document.getElementById('add-tools-modal').classList.remove('hidden'); }

    /** Closes the Add Tools modal. */
    function closeAddToolsModal() { document.getElementById('add-tools-modal').classList.add('hidden'); }

    /** Handles an action from the tools modal (e.g., Camera, Create Image). */
    function handleToolAction(tool, prompt = '') {
        closeAddToolsModal();
        if (prompt) {
            setPrompt(prompt);
        } else {
            showFeatureNotAvailable(tool);
        }
    }

    /** Re-enables the input field and resets typing state. */
    function enableInput() {
        const inputElement = document.getElementById('chat-input');
        inputElement.removeAttribute('disabled');
        isTyping = false;
        inputElement.focus();
    }


    /** Simulates the streaming effect of a TEXT response and handles source display. */
    async function streamResponse(content, bubble, sources = []) {
        const contentDiv = bubble.querySelector('.markdown-content');
        const footerDiv = bubble.querySelector('.ai-bubble-footer');

        const totalChunks = content.length;
        let streamedText = '';

        // Clear loading ellipsis and insert the cursor
        contentDiv.innerHTML = `<span class="typing-cursor"></span>`;

        // Simulate chunk delivery
        for (let i = 0; i < totalChunks; i++) {
            streamedText += content[i];

            if (i % 5 === 0 || i === totalChunks - 1) {
                const htmlContent = converter.makeHtml(streamedText);
                contentDiv.innerHTML = htmlContent + `<span class="typing-cursor"></span>`;
                scrollChatToBottom();
            }
            await new Promise(resolve => setTimeout(resolve, 5));
        }

        // Finalize the content
        contentDiv.innerHTML = converter.makeHtml(content);
        const cursor = bubble.querySelector('.typing-cursor');
        if (cursor) cursor.remove();
        
        // Add sources display if sources exist
        if (sources.length > 0) {
            const sourcesDiv = document.createElement('div');
            sourcesDiv.className = 'text-xs text-gray-500 pt-2 border-t border-gray-800 mt-2 flex flex-wrap gap-1';
            sourcesDiv.innerHTML = '<span class="font-semibold mr-1 text-purple-400">Sources:</span>';
            sources.slice(0, 3).forEach((source, index) => {
                const link = document.createElement('a');
                link.href = source.uri;
                link.target = '_blank';
                link.className = 'text-blue-400 hover:text-blue-300 transition-colors underline rounded-full px-2 py-0.5 bg-gray-700';
                link.textContent = `#${index + 1} ${source.title.substring(0, 30)}${source.title.length > 30 ? '...' : ''}`;
                sourcesDiv.appendChild(link);
            });
            contentDiv.appendChild(sourcesDiv);
        }

        footerDiv.classList.remove('hidden');

        // Add final response to chat history
        chatHistory.push({ role: 'model', content: content });

        scrollChatToBottom();
    }


    /** Renders the generated image and success message into the bubble. */
    function renderImageResult(imageUrl, bubble, prompt) {
        const contentDiv = bubble.querySelector('.markdown-content');
        contentDiv.classList.add('p-0');
        
        contentDiv.innerHTML = `
            <div class="p-3">
                <p class="text-sm font-semibold mb-2">${CONFIG.MESSAGES.image_success}</p>
                <img src="${imageUrl}" alt="${prompt}" class="w-full h-auto rounded-lg object-cover shadow-xl" />
                <p class="text-xs text-gray-500 mt-2 italic">${prompt}</p>
            </div>
        `;
    }

    /** Renders a single chat message bubble. */
    function renderMessage(role, content, isThinking = false) {
        const chatContainer = document.getElementById('chat-container-scrollable');

        const bubbleContainer = document.createElement('div');
        // Layout is always LTR, so user justification is fixed to end/right
        bubbleContainer.className = `flex mb-4 max-w-full ${role === 'user' ? 'justify-end' : 'justify-start'}`;
        
        const bubble = document.createElement('div');
        bubble.className = `rounded-xl p-3 max-w-[85%] sm:max-w-[70%] shadow-lg`;
        bubble.style.backgroundColor = role === 'user' ? 'var(--user-bubble)' : 'var(--ai-bubble)';
        bubble.style.color = 'var(--text-light)';

        if (role === 'user') {
            bubble.classList.add('rounded-tr-sm');
            bubble.innerHTML = `<p class="whitespace-pre-wrap">${content}</p>`;
        } else {
            bubble.classList.add('rounded-tl-sm', 'flex', 'flex-col');
            
            const contentDiv = document.createElement('div');
            // Important: Use LTR direction for Markdown content, as it's designed that way, 
            // but align the text correctly for Kurdish (RTL language)
            const textDirection = (currentLanguage === 'ku') ? 'rtl' : 'ltr';
            contentDiv.style.direction = textDirection;

            contentDiv.className = `markdown-content pb-2`;

            if (isThinking) {
                // Simplified thinking animation
                contentDiv.innerHTML = `<i data-lucide="loader" class="w-6 h-6 animate-spin text-gray-500"></i>`;
            } else {
                contentDiv.innerHTML = converter.makeHtml(content);
            }
            bubble.appendChild(contentDiv);

            const footerDiv = document.createElement('div');
            footerDiv.className = `ai-bubble-footer pt-2 flex justify-end text-xs space-x-3 text-gray-400 ${isThinking ? 'hidden' : ''}`;

            const actions = [
                { icon: 'copy', action: () => copyToClipboard(content) },
                { icon: 'volume-2', action: () => showFeatureNotAvailable(CONFIG.MESSAGES.action_tts) },
                { icon: 'rotate-cw', action: () => showFeatureNotAvailable(CONFIG.MESSAGES.action_regenerate) },
                { icon: 'thumbs-up', action: () => showToast(CONFIG.MESSAGES.action_like) },
                { icon: 'thumbs-down', action: () => showToast(CONFIG.MESSAGES.action_dislike) },
            ];

            actions.forEach(item => {
                const btn = document.createElement('button');
                btn.className = 'hover:text-white transition-colors p-1';
                btn.innerHTML = `<i data-lucide="${item.icon}" class="w-4 h-4"></i>`;
                btn.onclick = item.action;
                footerDiv.appendChild(btn);
            });

            bubble.appendChild(footerDiv);
        }

        bubbleContainer.appendChild(bubble);
        chatContainer.appendChild(bubbleContainer);

        lucide.createIcons();
        scrollChatToBottom();
        return bubbleContainer;
    }

    /** Scrolls the chat container to the bottom. */
    function scrollChatToBottom() {
        const container = document.getElementById('chat-container-scrollable');
        container.scrollTop = container.scrollHeight;
    }

    /** Displays a temporary toast notification. */
    function showToast(message) {
        let toast = document.getElementById('chat-toast');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = 'chat-toast';
            toast.className = 'fixed bottom-24 left-1/2 transform -translate-x-1/2 px-4 py-2 bg-gray-700 text-white text-sm rounded-full shadow-lg transition-opacity duration-300 z-50 opacity-0';
            document.body.appendChild(toast);
        }

        toast.textContent = message;
        toast.classList.remove('opacity-0');
        toast.classList.add('opacity-100');

        clearTimeout(toast.timer);
        toast.timer = setTimeout(() => {
            toast.classList.remove('opacity-100');
            toast.classList.add('opacity-0');
        }, 3000);
    }

    /** Copies text content to the clipboard and shows a toast. */
    function copyToClipboard(text) {
        const el = document.createElement('textarea');
        el.value = text;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        showToast(CONFIG.MESSAGES.action_copy_success);
    }

    /** Displays a feature not available message using the toast notification. */
    function showFeatureNotAvailable(featureName) {
        const message = CONFIG.MESSAGES.action_feature_not_available(featureName);
        showToast(message);
    }


    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Bind Enter key to send message
        document.getElementById('chat-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('send-button').click();
            }
        });

        // 2. Load recent chats from local storage
        loadRecentChats();
        
        // 3. Set the initial language UI (English)
        updateUIForLanguage();

        // 4. Initialize Lucide icons
        lucide.createIcons();
    });
</script>
</body>
</html>

